import { useEffect, useRef, useState } from 'react'
import { useMediaStreamStore } from '../store/MediaStreamStore'
import { socket } from '../configs/socket'

const rtcConfig: RTCConfiguration = {
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
}

export const useWebRTCVideo = (roomId: string, isHost: boolean) => {
  const localStream = useMediaStreamStore((s) => s.stream)
  const [remoteStream, setRemoteStream] = useState<MediaStream | null>(null)
  const pcRef = useRef<RTCPeerConnection | null>(null)
  const pendingCandidates = useRef<RTCIceCandidateInit[]>([])

  useEffect(() => {
    if (!localStream || !roomId) return

    const pc = new RTCPeerConnection(rtcConfig)
    pcRef.current = pc

    if (localStream) {
      localStream.getTracks().forEach((track) => {
        pc.addTrack(track, localStream)
      })
    }

    pc.ontrack = (event) => {
      console.log('ontrack:', event.track.kind)
      setRemoteStream((prev) => {
        const stream = prev ?? new MediaStream()
        stream.addTrack(event.track)
        return stream
      })
    }

    pc.onicecandidate = (e) => {
      if (e.candidate) {
        socket.emit('ice-candidate', {
          roomId,
          candidate: e.candidate
        })
      }
    }


    // JOINER nhận offer
    socket.on('offer', async (offer: RTCSessionDescriptionInit) => {
      await pc.setRemoteDescription(offer)

      // flush ICE đã nhận sớm
      for (const c of pendingCandidates.current) {
        await pc.addIceCandidate(c)
      }
      pendingCandidates.current = []

      const answer = await pc.createAnswer()
      await pc.setLocalDescription(answer)

      socket.emit('answer', { roomId, answer })
    })

    // HOST nhận answer
    socket.on('answer', async (answer: RTCSessionDescriptionInit) => {
      console.log(answer)
      await pc.setRemoteDescription(answer)

      for (const c of pendingCandidates.current) {
        await pc.addIceCandidate(c)
      }
      pendingCandidates.current = []
    })

    // ICE có thể đến trước
    socket.on('ice-candidate', async (candidate: RTCIceCandidateInit) => {
      if (pc.remoteDescription) {
        await pc.addIceCandidate(candidate)
      } else {
        pendingCandidates.current.push(candidate)
      }
    })

    if (isHost) {
      socket.on('peer-joined', async () => {
        const offer = await pc.createOffer()
        await pc.setLocalDescription(offer)

        socket.emit('offer', { roomId, offer })
      })
    }

    return () => {
      socket.off('offer')
      socket.off('answer')
      socket.off('ice-candidate')
      socket.off('peer-joined')
      pc.close()
    }
  }, [roomId, localStream, isHost])

  return { remoteStream }
}
